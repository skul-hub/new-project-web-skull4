<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Dashboard - STORESKULL</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // config.js content (Pastikan URL dan Key Supabase Anda sudah benar)
    const supabaseUrl = 'https://ivxlvkdvhroxkwbwnxda.supabase.co'; // GANTI DENGAN URL SUPABASE ANDA
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml2eGx2a2R2aHJveGt3YndueGRhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMDk2ODcsImV4cCI6MjA3Mzc4NTY4N30.owC5v3mU2NNAKxksaeHvdFmoyOqLAEYCOP1TIhKmroA'; // GANTI DENGAN ANON KEY SUPABASE ANDA
    const { createClient } = supabase;
    window.supabase = createClient(supabaseUrl, supabaseKey);
  </script>
  <script>
    // user-dashboard.js content
    let cart = [];
    let currentUser = null;
    let pendingCheckout = null;
    let uploadedProofUrl = null;
    let allProducts = [];
    let currentCategory = 'panel_pterodactyl';
    let pterodactylPanelUrl = '#'; // Global variable for Pterodactyl Panel URL

    /**
     * Memeriksa status autentikasi pengguna.
     * Jika tidak terautentikasi, redirect ke halaman login.
     */
    async function checkUserAuth() {
      const { data: { user }, error } = await window.supabase.auth.getUser();
      if (error || !user) {
        window.location.href = "signin.html";
        return;
      }

      // Ambil data profil pengguna dari tabel 'users' (public schema).
      const { data: userData, error: userError } = await window.supabase
        .from("users") // Ganti 'users' jika nama tabel profil Anda berbeda.
        .select("*")
        .eq("id", user.id)
        .single();

      if (userError || !userData) {
        alert("Gagal memuat profil pengguna. Silakan coba lagi atau hubungi admin.");
        console.error("Error fetching user profile:", userError);
        await window.supabase.auth.signOut(); // Logout jika profil tidak dapat dimuat.
        window.location.href = "signin.html";
        return;
      }

      currentUser = userData;
      await loadGlobalSettings(); // Muat pengaturan global termasuk URL Pterodactyl Panel.
      showSection("products"); // Tampilkan bagian produk secara default.
      loadAnnouncement(); // Muat pengumuman.
    }

    /**
     * Memuat pengaturan global dari database.
     */
    async function loadGlobalSettings() {
      const { data, error } = await window.supabase.from("settings").select("pterodactyl_panel_url").single();
      if (error && error.code !== 'PGRST116') { // PGRST116 berarti tidak ada baris ditemukan.
        console.error("Error loading global settings:", error);
      }
      if (data && data.pterodactyl_panel_url) {
        pterodactylPanelUrl = data.pterodactyl_panel_url;
      }
    }

    /**
     * Memuat daftar produk aktif dari database.
     */
    async function loadProducts() {
      const { data, error } = await window.supabase.from("products").select("*").eq("active", true);
      if (error) {
        console.error("Error loading products:", error);
        return;
      }

      allProducts = data || [];
      filterProductsByCategory(currentCategory); // Filter produk berdasarkan kategori saat ini.
    }

    /**
     * Menampilkan produk ke dalam container HTML.
     * @param {Array} productsToDisplay - Array produk yang akan ditampilkan.
     */
    function displayProducts(productsToDisplay) {
      const container = document.getElementById("productsContainer");
      container.innerHTML = ""; // Bersihkan konten sebelumnya.
      if (productsToDisplay && productsToDisplay.length > 0) {
        productsToDisplay.forEach((p) => {
          const safeName = p.name.replace(/'/g, "\\'");
          const div = document.createElement("div");
          div.className = "product";
          let stockInfo = '';
          let buyButton = `<button onclick="buyNow('${p.id}', '${safeName}', ${p.price})">Beli Sekarang</button>`;
          let cartButton = `<button onclick="addToCart('${p.id}', '${safeName}', ${p.price})">Tambah ke Keranjang</button>`;

          if (p.category === 'game_account') {
            stockInfo = `<p>Stok: <strong>${p.stock}</strong></p>`;
            if (p.stock <= 0) {
              buyButton = `<button disabled>Stok Habis</button>`;
              cartButton = `<button disabled>Stok Habis</button>`;
            }
          } else if (p.category === 'panel_pterodactyl') {
            stockInfo = `<p>Status: <strong>Tersedia</strong></p>`;
          }

          div.innerHTML = `
            <h3>${p.name}</h3>
            <p>Rp ${p.price.toLocaleString()}</p>
            ${stockInfo}
            <img src="${p.image}" alt="${p.name}">
            ${buyButton}
            ${cartButton}
          `;
          container.appendChild(div);
        });
      } else {
        container.innerHTML = "<p>Tidak ada produk yang ditemukan dalam kategori ini.</p>";
      }
    }

    /**
     * Memfilter produk berdasarkan istilah pencarian dan kategori saat ini.
     */
    function filterProducts() {
      const searchTerm = document.getElementById("productSearch").value.toLowerCase();
      const filtered = allProducts.filter(product =>
        product.category === currentCategory &&
        product.name.toLowerCase().includes(searchTerm)
      );
      displayProducts(filtered);
    }

    /**
     * Memfilter produk berdasarkan kategori yang dipilih.
     * @param {string} category - Kategori produk yang akan ditampilkan.
     */
    function filterProductsByCategory(category) {
      currentCategory = category;
      const buttons = document.querySelectorAll('.category-button');
      buttons.forEach(button => {
        if (button.onclick.toString().includes(`'${category}'`)) {
          button.classList.add('active');
        } else {
          button.classList.remove('active');
        }
      });
      filterProducts(); // Panggil filterProducts untuk menerapkan filter kategori dan pencarian.
    }

    /**
     * Menambahkan produk ke keranjang belanja.
     * @param {string} id - ID produk.
     * @param {string} name - Nama produk.
     * @param {number} price - Harga produk.
     */
    async function addToCart(id, name, price) {
      const product = allProducts.find(p => p.id === id);
      if (product.category === 'game_account' && product.stock <= 0) {
        alert("Stok produk ini sudah habis!");
        return;
      }

      const existingItem = cart.find(item => item.id === id);
      if (existingItem) {
        alert("Produk ini sudah ada di keranjang!");
        return;
      }
      cart.push({ id, name, price, category: product.category });
      updateCartDisplay();
      alert("Ditambahkan ke Keranjang By Bangskull!");
    }

    /**
     * Memperbarui tampilan keranjang belanja.
     */
    function updateCartDisplay() {
      const total = cart.reduce((sum, p) => sum + p.price, 0);
      const cartDiv = document.getElementById("cartItems");
      cartDiv.innerHTML = "";

      if (cart.length === 0) {
        cartDiv.innerHTML = "<p>Keranjang kosong.</p>";
      } else {
        cart.forEach((p, index) => {
          const item = document.createElement("p");
          item.innerHTML = `${p.name} - Rp ${p.price.toLocaleString()} <button onclick="removeFromCart(${index})">Hapus</button>`;
          cartDiv.appendChild(item);
        });
        cartDiv.innerHTML += `<p><strong>Total: Rp ${total.toLocaleString()}</strong></p>`;
      }
    }

    /**
     * Menghapus produk dari keranjang belanja.
     * @param {number} index - Indeks produk di array keranjang.
     */
    function removeFromCart(index) {
      cart.splice(index, 1);
      updateCartDisplay();
      alert("Produk dihapus dari keranjang.");
    }

    /**
     * Memulai proses pembelian langsung untuk satu produk.
     * @param {string} pid - ID produk.
     * @param {string} name - Nama produk.
     * @param {number} price - Harga produk.
     */
    async function buyNow(pid, name, price) {
      if (!currentUser) return alert("Silakan login.");

      const product = allProducts.find(p => p.id === pid);
      if (product.category === 'game_account' && product.stock <= 0) {
        alert("Stok produk ini sudah habis!");
        return;
      }

      pendingCheckout = { mode: "single", item: { id: pid, name, price, category: product.category } };
      await openQris();
    }

    /**
     * Memulai proses checkout untuk semua produk di keranjang.
     */
    async function checkout() {
      if (cart.length === 0) return alert("Keranjang kosong!");
      if (!currentUser) return alert("Silakan login.");

      // Periksa stok untuk semua item di keranjang sebelum checkout.
      for (const item of cart) {
        const product = allProducts.find(p => p.id === item.id);
        if (product.category === 'game_account' && product.stock <= 0) {
          alert(`Stok untuk produk "${product.name}" sudah habis. Silakan hapus dari keranjang.`);
          return;
        }
      }

      pendingCheckout = { mode: "cart" };
      await openQris();
    }

    /**
     * Membuka modal QRIS untuk pembayaran.
     */
    async function openQris() {
      const { data, error } = await window.supabase.from("settings").select("qris_image_url").single();
      if (error || !data || !data.qris_image_url) {
        alert("QRIS belum diatur oleh admin. Silakan hubungi admin.");
        return;
      }
      document.getElementById("qrisImage").src = data.qris_image_url;
      document.getElementById("qrisModal").style.display = "flex";
    }

    /**
     * Menutup modal QRIS.
     */
    function closeQris() {
      document.getElementById("qrisModal").style.display = "none";
      document.getElementById("proofFile").value = ""; // Bersihkan input file.
    }

    /**
     * Mengkonfirmasi pembayaran dengan mengupload bukti transfer.
     */
    async function confirmPayment() {
      const file = document.getElementById("proofFile").files[0];
      if (!file) return alert("Upload bukti transfer dulu.");

      if (file.size > 2 * 1024 * 1024) {
        alert("Ukuran bukti transfer terlalu besar. Maksimal 2MB.");
        return;
      }

      // Upload bukti transfer ke Supabase Storage.
      const fileName = `${Date.now()}_${file.name.replace(/\s+/g, "_")}`;
      const path = `${currentUser.id}/${fileName}`;
      const { error: upErr } = await window.supabase.storage.from("proofs").upload(path, file);
      if (upErr) {
        alert("Gagal upload bukti: " + upErr.message);
        return;
      }
      const { data: urlData } = window.supabase.storage.from("proofs").getPublicUrl(path);
      uploadedProofUrl = urlData.publicUrl;

      closeQris();
      document.getElementById("emailModal").style.display = "flex"; // Buka modal email.
    }

    /**
     * Menutup modal email.
     */
    function closeEmail() {
      document.getElementById("emailModal").style.display = "none";
      uploadedProofUrl = null;
    }

    /**
     * Mengirim email kontak dan memproses pesanan.
     */
    async function submitEmail() {
      if (!pendingCheckout) {
        alert("Transaksi tidak ditemukan. Silakan ulangi proses checkout.");
        return;
      }

      const email = document.getElementById("emailInput").value.trim();
      if (!email || !email.includes("@")) return alert("Masukkan email yang valid.");

      let ordersToNotify = [];
      let productsToUpdateStock = [];
      let ordersToProvision = [];

      // Proses pesanan tunggal atau dari keranjang.
      if (pendingCheckout.mode === "single") {
        const product = allProducts.find(p => p.id === pendingCheckout.item.id);
        if (product.category === 'game_account' && product.stock <= 0) {
          alert("Stok produk ini sudah habis. Transaksi dibatalkan.");
          closeEmail();
          return;
        }
        const order = await createOrder(pendingCheckout.item, uploadedProofUrl, email);
        if (order) {
          ordersToNotify.push(order);
          if (product.category === 'game_account') {
            productsToUpdateStock.push({ id: product.id, newStock: product.stock - 1 });
          } else if (product.category === 'panel_pterodactyl') {
            ordersToProvision.push(order.id);
          }
        }
      } else if (pendingCheckout.mode === "cart") {
        for (const p of cart) {
          const product = allProducts.find(prod => prod.id === p.id);
          if (product.category === 'game_account' && product.stock <= 0) {
            alert(`Stok untuk produk "${product.name}" sudah habis. Transaksi dibatalkan.`);
            closeEmail();
            return;
          }
          const order = await createOrder(p, uploadedProofUrl, email);
          if (order) {
            ordersToNotify.push(order);
            if (product.category === 'game_account') {
              productsToUpdateStock.push({ id: product.id, newStock: product.stock - 1 });
            } else if (product.category === 'panel_pterodactyl') {
              ordersToProvision.push(order.id);
            }
          }
        }
        cart = []; // Kosongkan keranjang setelah checkout.
        updateCartDisplay();
      }

      // Perbarui stok produk di database.
      for (const item of productsToUpdateStock) {
        await window.supabase.from("products").update({ stock: item.newStock }).eq("id", item.id);
      }

      // Otomatis provision server Pterodactyl jika ada.
      for (const orderId of ordersToProvision) {
        try {
          const response = await fetch("/api/provision-pterodactyl", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ order_id: orderId }),
          });
          const result = await response.json();
          if (!result.success) {
            console.error(`Failed to auto-provision server for order ${orderId}:`, result.error);
            alert(`Gagal otomatis memprovision server untuk pesanan ${orderId}. Admin akan menanganinya secara manual.`);
          } else {
            console.log(`Successfully auto-provisioned server for order ${orderId}`);
            const notifiedOrder = ordersToNotify.find(o => o.id === orderId);
            if (notifiedOrder) notifiedOrder.status = 'done'; // Perbarui status untuk notifikasi.
          }
        } catch (error) {
          console.error(`Error calling provisioning API for order ${orderId}:`, error);
          alert(`Terjadi kesalahan saat memanggil API provisioning untuk pesanan ${orderId}. Admin akan menanganinya secara manual.`);
        }
      }

      // Kirim notifikasi ke Telegram admin.
      if (ordersToNotify.length > 0) {
        await fetch("/api/notify", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ orders: ordersToNotify }),
        });
      }

      document.getElementById("emailModal").style.display = "none";
      alert("✅ Pesanan dibuat! Admin akan konfirmasi.\n\n📧 Produk akan dikirim ke email yang Anda masukkan.");
      loadHistory(); // Muat ulang riwayat pesanan.
      loadProducts(); // Muat ulang produk untuk memperbarui stok.

      pendingCheckout = null;
      uploadedProofUrl = null;
    }

    /**
     * Membuat entri pesanan baru di database.
     * @param {object} p - Objek produk.
     * @param {string} proofUrl - URL bukti transfer.
     * @param {string} email - Email kontak pengguna.
     * @returns {Promise<object|null>} Objek pesanan yang dibuat atau null jika gagal.
     */
    async function createOrder(p, proofUrl, email) {
      const { data, error } = await window.supabase.from("orders").insert([{
        product_id: p.id,
        user_id: currentUser.id,
        username: currentUser.username,
        payment_method: "qris",
        payment_proof: proofUrl,
        contact_email: email,
        status: "waiting_confirmation",
      }]).select("id, user_id, product_id, status, payment_proof, contact_email, pterodactyl_server_id").single();

      if (error) {
        alert("Gagal membuat order untuk " + p.name + ": " + error.message);
        console.error("Error creating order:", error);
        return null;
      }

      return {
        id: data.id,
        username: currentUser.username,
        product_name: p.name,
        payment_method: "qris",
        payment_proof: proofUrl,
        contact_email: email,
        status: "waiting_confirmation",
        product_category: p.category,
        pterodactyl_server_id: data.pterodactyl_server_id,
        pterodactyl_panel_url: pterodactylPanelUrl, // Kirim URL panel global
      };
    }

    let currentOrderIdForRating = null;
    let currentProductIdForRating = null;

    /**
     * Membuka modal rating untuk pesanan tertentu.
     * @param {string} orderId - ID pesanan.
     * @param {string} productId - ID produk.
     */
    async function openRatingModal(orderId, productId) {
      currentOrderIdForRating = orderId;
      currentProductIdForRating = productId;

      const { data: productData, error: productError } = await window.supabase
        .from("products")
        .select("name")
        .eq("id", productId)
        .single();

      if (productError || !productData) {
        console.error("Error fetching product name for rating:", productError);
        alert("Gagal memuat informasi produk untuk rating.");
        return;
      }

      document.getElementById("ratingProductName").textContent = productData.name;

      // Reset bintang dan komentar di modal.
      const stars = document.querySelectorAll(".rating-stars .star");
      stars.forEach(star => {
        star.classList.remove("selected");
      });
      document.getElementById("selectedRating").value = "0";
      document.getElementById("ratingComment").value = "";

      // Muat rating yang sudah ada jika ada.
      const { data: existingRating, error: ratingError } = await window.supabase
        .from("ratings")
        .select("*")
        .eq("order_id", orderId)
        .single();

      if (existingRating) {
        document.getElementById("selectedRating").value = existingRating.rating;
        document.getElementById("ratingComment").value = existingRating.comment || "";
        stars.forEach(star => {
          if (parseInt(star.dataset.value) <= existingRating.rating) {
            star.classList.add("selected");
          }
        });
      }

      document.getElementById("ratingModal").style.display = "flex";
    }

    /**
     * Menutup modal rating.
     */
    function closeRatingModal() {
      document.getElementById("ratingModal").style.display = "none";
      currentOrderIdForRating = null;
      currentProductIdForRating = null;
    }

    // Event listener untuk bintang rating.
    document.addEventListener("DOMContentLoaded", () => {
      if (!document.body.dataset.ratingListenerAdded) {
        const stars = document.querySelectorAll(".rating-stars .star");
        stars.forEach(star => {
          star.addEventListener("click", function() {
            const ratingValue = parseInt(this.dataset.value);
            document.getElementById("selectedRating").value = ratingValue;
            stars.forEach(s => {
              if (parseInt(s.dataset.value) <= ratingValue) {
                s.classList.add("selected");
              } else {
                s.classList.remove("selected");
              }
            });
          });
        });
        document.body.dataset.ratingListenerAdded = true;
      }
    });

    /**
     * Mengirim rating dan komentar ke database.
     */
    async function submitRating() {
      const rating = parseInt(document.getElementById("selectedRating").value);
      const comment = document.getElementById("ratingComment").value.trim();

      if (rating === 0) {
        alert("Silakan pilih bintang rating!");
        return;
      }

      if (!currentOrderIdForRating || !currentProductIdForRating || !currentUser) {
        alert("Terjadi kesalahan. Silakan coba lagi.");
        return;
      }

      // Cek apakah sudah ada rating untuk pesanan ini.
      const { data: existingRating, error: checkError } = await window.supabase
        .from("ratings")
        .select("id")
        .eq("order_id", currentOrderIdForRating)
        .single();

      let error;
      if (existingRating) {
        // Update rating yang sudah ada.
        ({ error } = await window.supabase
          .from("ratings")
          .update({ rating: rating, comment: comment, created_at: new Date() })
          .eq("id", existingRating.id));
      } else {
        // Insert rating baru.
        ({ error } = await window.supabase.from("ratings").insert([{
          order_id: currentOrderIdForRating,
          user_id: currentUser.id,
          product_id: currentProductIdForRating,
          rating: rating,
          comment: comment,
        }]));
      }

      if (error) {
        alert("Gagal menyimpan rating: " + error.message);
        console.error("Error saving rating:", error);
        return;
      }

      alert("Terima kasih atas rating Anda!");
      closeRatingModal();
      loadHistory(); // Muat ulang riwayat pesanan untuk memperbarui tombol rating.
      loadAllRatings(); // Muat ulang semua rating.
    }

    /**
     * Memuat riwayat pesanan pengguna.
     */
    async function loadHistory() {
      const { data, error } = await window.supabase
        .from("orders_view") // Menggunakan view untuk mendapatkan detail produk dan user.
        .select("*")
        .eq("user_id", currentUser.id)
        .order("created_at", { ascending: false });

      if (error) {
        console.error("Error loading order history:", error);
        return;
      }

      const historyDiv = document.getElementById("historyItems");
      historyDiv.innerHTML = "";
      if (data && data.length > 0) {
        for (const o of data) {
          const div = document.createElement("div");
          div.className = "order";

          let ratingButton = '';
          if (o.status === 'done') {
            // Cek apakah pengguna sudah memberikan rating untuk pesanan ini.
            const { data: existingRating, error: ratingCheckError } = await window.supabase
              .from("ratings")
              .select("id")
              .eq("order_id", o.id)
              .single();

            if (ratingCheckError && ratingCheckError.code !== 'PGRST116') {
              console.error("Error checking existing rating:", ratingCheckError);
            }

            const buttonText = existingRating ? "Lihat/Ubah Rating" : "Beri Rating";
            ratingButton = `<button onclick="openRatingModal('${o.id}', '${o.product_id}')" class="admin-button" style="margin-top: 10px;">${buttonText}</button>`;
          }

          let pterodactylInfo = '';
          if (o.product_category === 'panel_pterodactyl' && o.status === 'done' && o.pterodactyl_server_id) {
            pterodactylInfo = `<p><b>Server ID Pterodactyl:</b> <code>${o.pterodactyl_server_id}</code></p>
                                <p><b>URL Panel:</b> <a href="${pterodactylPanelUrl || '#'}" target="_blank">${pterodactylPanelUrl || 'N/A'}</a></p>`;
          } else if (o.product_category === 'panel_pterodactyl' && o.status !== 'done') {
            pterodactylInfo = `<p><i>Server Pterodactyl akan diprovision setelah pesanan selesai.</i></p>`;
          }

          div.innerHTML = `
            <p><strong>Order ID:</strong> ${o.id}</p>
            <p><strong>Produk:</strong> ${o.product_name} - Rp ${o.product_price.toLocaleString()}</p>
            <p><strong>Status:</strong> ${o.status.replace(/_/g, ' ').toUpperCase()}</p>
            <p><strong>Metode Pembayaran:</strong> ${o.payment_method.toUpperCase()}</p>
            <p><strong>Email:</strong> ${o.contact_email || "-"}</p>
            <p><strong>Bukti Transfer:</strong> ${
              o.payment_proof
                ? `<a href="${o.payment_proof}" target="_blank">Lihat Bukti</a>`
                : "-"
            }</p>
            <p><strong>Tanggal Pesan:</strong> ${new Date(o.created_at).toLocaleString()}</p>
            ${pterodactylInfo}
            ${ratingButton}
          `;
          historyDiv.appendChild(div);
        }
      } else {
        historyDiv.innerHTML = "<p>Belum ada riwayat pesanan.</p>";
      }
    }

    /**
     * Memuat semua rating produk dari database untuk ditampilkan secara global.
     */
    async function loadAllRatings() {
      const { data: ratings, error } = await window.supabase
        .from("ratings")
        .select(`
          id,
          rating,
          comment,
          created_at,
          users(username),
          products(name)
        `)
        .order("created_at", { ascending: false });

      if (error) {
        console.error("Error loading global ratings:", error);
        return;
      }

      const container = document.getElementById("globalRatingsList");
      container.innerHTML = "";

      if (ratings && ratings.length > 0) {
        displayGlobalRatingStatistics(ratings); // Tampilkan statistik rating global.

        const table = document.createElement("table");
        table.className = "ratings-table";
        table.innerHTML = `
          <thead>
            <tr>
              <th>User</th>
              <th>Produk</th>
              <th>Rating</th>
              <th>Komentar</th>
              <th>Tanggal</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        `;
        const tbody = table.querySelector("tbody");

        ratings.forEach((r) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${r.users ? r.users.username : 'N/A'}</td>
            <td>${r.products ? r.products.name : 'N/A'}</td>
            <td>${'⭐'.repeat(r.rating)} (${r.rating}/5)</td>
            <td>${r.comment || '-'}</td>
            <td>${new Date(r.created_at).toLocaleString()}</td>
          `;
          tbody.appendChild(tr);
        });
        container.appendChild(table);
      } else {
        // Reset statistik jika tidak ada rating.
        document.getElementById("globalTotalRatingsCount").textContent = "0";
        document.getElementById("globalAverageRating").textContent = "0.0";
        for (let i = 1; i <= 5; i++) {
          document.getElementById(`globalStar${i}Count`).textContent = "0";
          document.getElementById(`globalStar${i}Percent`).textContent = "0%";
          document.getElementById(`globalStar${i}Bar`).style.width = "0%";
        }
        container.innerHTML = "<p>Belum ada rating atau komentar dari pengguna.</p>";
      }
    }

    /**
     * Menampilkan statistik rating global.
     * @param {Array} ratings - Array objek rating.
     */
    function displayGlobalRatingStatistics(ratings) {
      const totalRatings = ratings.length;
      let sumRatings = 0;
      const starCounts = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };

      ratings.forEach(r => {
        sumRatings += r.rating;
        starCounts[r.rating]++;
      });

      const averageRating = totalRatings > 0 ? (sumRatings / totalRatings).toFixed(1) : "0.0";

      document.getElementById("globalTotalRatingsCount").textContent = totalRatings;
      document.getElementById("globalAverageRating").textContent = averageRating;

      for (let i = 1; i <= 5; i++) {
        const count = starCounts[i];
        const percentage = totalRatings > 0 ? ((count / totalRatings) * 100).toFixed(1) : "0.0";
        document.getElementById(`globalStar${i}Count`).textContent = count;
        document.getElementById(`globalStar${i}Percent`).textContent = `${percentage}%`;
        document.getElementById(`globalStar${i}Bar`).style.width = `${percentage}%`;
      }
    }

    /**
     * Memuat dan menampilkan pengumuman dari pengaturan.
     */
    async function loadAnnouncement() {
      const { data, error } = await window.supabase.from("settings").select("announcement").single();
      const announcementContainer = document.getElementById("announcementContainer");
      const announcementMessage = document.getElementById("announcementMessage");

      if (error && error.code !== 'PGRST116') {
        console.error("Error loading announcement:", error);
        announcementContainer.style.display = "none";
        return;
      }

      if (data && data.announcement) {
        announcementMessage.textContent = data.announcement;
        announcementContainer.style.display = "block";
      } else {
        announcementContainer.style.display = "none";
      }
    }

    /**
     * Menampilkan bagian dashboard yang dipilih.
     * @param {string} section - ID dari bagian yang akan ditampilkan.
     */
    function showSection(section) {
      document.getElementById("products").style.display = "none";
      document.getElementById("cart").style.display = "none";
      document.getElementById("history").style.display = "none";
      document.getElementById("all-ratings").style.display = "none";
      document.getElementById(section).style.display = "block";

      if (section === "products") {
        loadProducts();
        document.getElementById("productSearch").value = "";
        filterProductsByCategory('panel_pterodactyl'); // Default kategori saat masuk ke produk.
      }
      if (section === "cart") updateCartDisplay();
      if (section === "history") loadHistory();
      if (section === "all-ratings") loadAllRatings();
    }

    // Panggil fungsi checkUserAuth saat halaman dimuat.
    window.onload = () => {
      checkUserAuth();
    };

    /**
     * Melakukan logout pengguna.
     */
    async function logout() {
      await window.supabase.auth.signOut();
      window.location.href = "signin.html";
    }
  </script>
</head>
<body>
  <header>
    <nav class="navbar">
      <div class="navbar-brand">
        <h1><a href="user-dashboard.html">STORESKULL</a></h1>
      </div>
      <ul class="nav-links">
        <li><a href="#" onclick="showSection('products')">Produk</a></li>
        <li><a href="#" onclick="showSection('cart')">Keranjang</a></li>
        <li><a href="#" onclick="showSection('history')">History</a></li>
        <li><a href="#" onclick="showSection('all-ratings')">Semua Rating Produk</a></li>
        <li><a href="#" onclick="logout()">Logout</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <!-- Pengumuman -->
    <div id="announcementContainer" style="display:none; background: #238636; color: white; padding: 1rem; border-radius: 8px; margin-bottom: 2rem; text-align: center;">
      <p id="announcementMessage"></p>
    </div>

    <!-- Tombol Telegram Baru -->
    <div class="telegram-button-container">
      <a href="https://t.me/skullhosting" target="_blank" class="telegram-button">
        <img src="img/tele.png" alt="Telegram Logo" class="telegram-logo">
        <span>Hubungi Kami di Telegram</span>
      </a>
    </div>

    <!-- Produk -->
    <section id="products">
      <h2>Produk</h2>
      <div class="search-container">
        <input type="text" id="productSearch" placeholder="Cari produk..." onkeyup="filterProducts()">
      </div>
      <div class="product-categories">
        <button class="category-button active" onclick="filterProductsByCategory('panel_pterodactyl')">Panel Pterodactyl</button>
        <button class="category-button" onclick="filterProductsByCategory('game_account')">KHUSUS PROMO</button>
      </div>
      <div id="productsContainer" class="products-grid"></div>
    </section>

    <!-- Keranjang -->
    <section id="cart" style="display:none;">
      <h2>Keranjang Kamu</h2>
      <div id="cartItems"></div>
      <button onclick="checkout()">Checkout</button>
    </section>

    <!-- Riwayat Pesanan -->
    <section id="history" style="display:none;">
      <h2>Order History</h2>
      <div id="historyItems"></div>
    </section>

    <!-- Semua Rating Produk -->
    <section id="all-ratings" style="display:none;">
      <h2>Semua Rating Produk</h2>

      <div class="rating-summary">
        <h3>Statistik Rating Keseluruhan</h3>
        <div id="globalRatingStats">
          <p>Total Rating: <strong id="globalTotalRatingsCount">0</strong></p>
          <p>Rata-rata Rating: <strong id="globalAverageRating">0.0</strong></p>
          <p>Bintang 5: <strong id="globalStar5Count">0</strong> (<span id="globalStar5Percent">0%</span>)
            <div class="progress-bar-container"><div id="globalStar5Bar" class="progress-bar"></div></div></p>
          <p>Bintang 4: <strong id="globalStar4Count">0</strong> (<span id="globalStar4Percent">0%</span>)
            <div class="progress-bar-container"><div id="globalStar4Bar" class="progress-bar"></div></div></p>
          <p>Bintang 3: <strong id="globalStar3Count">0</strong> (<span id="globalStar3Percent">0%</span>)
            <div class="progress-bar-container"><div id="globalStar3Bar" class="progress-bar"></div></div></p>
          <p>Bintang 2: <strong id="globalStar2Count">0</strong> (<span id="globalStar2Percent">0%</span>)
            <div class="progress-bar-container"><div id="globalStar2Bar" class="progress-bar"></div></div></p>
          <p>Bintang 1: <strong id="globalStar1Count">0</strong> (<span id="globalStar1Percent">0%</span>)
            <div class="progress-bar-container"><div id="globalStar1Bar" class="progress-bar"></div></div></p>
        </div>
      </div>

      <div id="globalRatingsList">
        <!-- Daftar rating akan dimuat di sini oleh JS -->
      </div>
    </section>
  </main>

  <!-- QRIS Modal -->
  <div id="qrisModal" class="modal" style="display:none;">
    <div class="modal-content">
      <h3>Scan QRIS untuk Pembayaran</h3>
      <img id="qrisImage" alt="QRIS" style="width:250px;height:250px;object-fit:contain;">
      <p>Setelah transfer, upload bukti pembayaran:</p>
      <input type="file" id="proofFile" accept="image/*">
      <div class="row">
        <button type="button" onclick="confirmPayment()">Lanjutkan</button>
        <button type="button" onclick="closeQris()">Batal</button>
      </div>
    </div>
  </div>

  <!-- Email Modal Baru -->
  <div id="emailModal" class="modal" style="display:none;">
    <div class="modal-content">
      <h3>Masukkan Email Anda</h3>
      <p style="color:red;"><strong>⚠️ Pastikan email aktif!</strong> Produk akan dikirim ke email ini.</p>
      <input type="email" id="emailInput" placeholder="contoh: nama@email.com" required>
      <div class="row">
        <button type="button" onclick="submitEmail()">Kirim</button>
        <button type="button" onclick="closeEmail()">Batal</button>
      </div>
    </div>
  </div>

  <!-- Rating Modal -->
  <div id="ratingModal" class="modal" style="display:none;">
    <div class="modal-content">
      <h3>Beri Rating untuk Pesanan Anda</h3>
      <p>Produk: <strong id="ratingProductName"></strong></p>
      <div class="rating-stars" style="font-size: 2rem; cursor: pointer;">
        <span class="star" data-value="1">⭐</span>
        <span class="star" data-value="2">⭐</span>
        <span class="star" data-value="3">⭐</span>
        <span class="star" data-value="4">⭐</span>
        <span class="star" data-value="5">⭐</span>
      </div>
      <input type="hidden" id="selectedRating" value="0">
      <textarea id="ratingComment" rows="4" placeholder="Tulis komentar Anda di sini (opsional)..."></textarea>
      <div class="row">
        <button type="button" onclick="submitRating()">Kirim Rating</button>
        <button type="button" onclick="closeRatingModal()">Batal</button>
      </div>
    </div>
  </div>

  <footer>
    <p>&copy; 2025 STORESKULL</p>
  </footer>
</body>
</html>
