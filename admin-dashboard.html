<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - STORESKULL</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // config.js content (Pastikan URL dan Key Supabase Anda sudah benar)
    const supabaseUrl = 'https://ivxlvkdvhroxkwbwnxda.supabase.co'; // GANTI DENGAN URL SUPABASE ANDA
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml2eGx2a2R2aHJveGt3YndueGRhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMDk2ODcsImV4cCI6MjA3Mzc4NTY4N30.owC5v3mU2NNAKxksaeHvdHvdFmoyOqLAEYCOP1TIhKmroA'; // GANTI DENGAN ANON KEY SUPABASE ANDA
    const { createClient } = supabase;
    window.supabase = createClient(supabaseUrl, supabaseKey);
  </script>
  <script>
    // admin-dashboard.js content
    let currentAdmin = null;
    let pterodactylConfigs = []; // Untuk menyimpan konfigurasi Pterodactyl yang tersedia

    /**
     * Memeriksa status autentikasi admin.
     * Jika tidak terautentikasi atau bukan admin, redirect ke halaman login.
     */
    async function checkAdminAuth() {
      const { data: { user }, error } = await window.supabase.auth.getUser();
      if (error || !user) {
        window.location.href = "signin.html";
        return;
      }

      const { data: userData } = await window.supabase.from("users").select("*").eq("id", user.id).single();
      if (!userData || userData.role !== "admin") {
        alert("Akses ditolak. Anda bukan admin.");
        window.location.href = "signin.html";
        return;
      }

      currentAdmin = userData;
      // Setelah autentikasi berhasil, tampilkan bagian produk secara default.
      showSection("products");
    }

    /**
     * Menampilkan bagian dashboard yang dipilih dan memuat data yang relevan.
     * @param {string} section - ID dari bagian yang akan ditampilkan (e.g., "products", "orders").
     */
    function showSection(section) {
      // Sembunyikan semua bagian terlebih dahulu.
      document.getElementById("products").style.display = "none";
      document.getElementById("orders").style.display = "none";
      document.getElementById("settings").style.display = "none";
      document.getElementById("ratings").style.display = "none";
      document.getElementById("pterodactyl-settings").style.display = "none"; // Bagian baru Pterodactyl
      
      // Tampilkan bagian yang dipilih.
      document.getElementById(section).style.display = "block";

      // Muat data spesifik untuk setiap bagian.
      if (section === "products") loadProducts();
      if (section === "orders") loadOrders();
      if (section === "settings") loadQrisSettings();
      if (section === "ratings") loadRatings();
      if (section === "pterodactyl-settings") loadPterodactylSettings();
    }

    // --- Pterodactyl Config Management ---

    /**
     * Memuat semua konfigurasi Pterodactyl dari database.
     * Data akan disimpan di variabel global `pterodactylConfigs`.
     * @returns {Promise<Array>} Array berisi konfigurasi Pterodactyl.
     */
    async function loadPterodactylConfigs() {
      console.log("Attempting to load Pterodactyl configs...");
      const { data, error } = await window.supabase.from("pterodactyl_configs").select("*").order("name", { ascending: true });
      if (error) {
        console.error("Error loading Pterodactyl configs:", error);
        alert("Gagal memuat konfigurasi Pterodactyl: " + error.message);
        return [];
      }
      pterodactylConfigs = data || [];
      console.log("Pterodactyl configs loaded:", pterodactylConfigs);
      return pterodactylConfigs;
    }

    /**
     * Merender daftar konfigurasi Pterodactyl ke dalam elemen HTML.
     */
    async function renderPterodactylConfigs() {
      const container = document.getElementById("pterodactylConfigsList");
      container.innerHTML = ""; // Bersihkan konten sebelumnya.

      if (pterodactylConfigs.length === 0) {
        container.innerHTML = "<p>Belum ada konfigurasi Pterodactyl yang ditambahkan.</p>";
        return;
      }

      // Buat elemen untuk setiap konfigurasi.
      pterodactylConfigs.forEach(config => {
        const div = document.createElement("div");
        div.className = "pterodactyl-config-item";
        div.innerHTML = `
          <p><strong>${config.name}</strong></p>
          <p>Egg ID: ${config.egg_id}, Nest ID: ${config.nest_id}, Location ID: ${config.location_id}</p>
          <p>Memory: ${config.memory}MB, CPU: ${config.cpu}%, Disk: ${config.disk}MB, Swap: ${config.swap}MB, IO: ${config.io}</p>
          <div class="config-actions">
            <button onclick="editPterodactylConfig('${config.id}')" class="admin-button">‚úèÔ∏è Edit</button>
            <button onclick="deletePterodactylConfig('${config.id}')" class="admin-button delete">üóëÔ∏è Hapus</button>
          </div>
        `;
        container.appendChild(div);
      });
    }

    /**
     * Menambahkan atau memperbarui konfigurasi Pterodactyl.
     * @param {Event} event - Objek event dari form submit.
     */
    async function addOrUpdatePterodactylConfig(event) {
      event.preventDefault(); // Mencegah refresh halaman.

      const configId = document.getElementById("configId").value;
      const name = document.getElementById("configName").value;
      const egg_id = parseInt(document.getElementById("configEggId").value, 10);
      const nest_id = parseInt(document.getElementById("configNestId").value, 10);
      const location_id = parseInt(document.getElementById("configLocationId").value, 10);
      const memory = parseInt(document.getElementById("configMemory").value, 10);
      const cpu = parseInt(document.getElementById("configCpu").value, 10);
      const disk = parseInt(document.getElementById("configDisk").value, 10);
      const swap = parseInt(document.getElementById("configSwap").value, 10);
      const io = parseInt(document.getElementById("configIo").value, 10);

      // Validasi input.
      if (!name || isNaN(egg_id) || isNaN(nest_id) || isNaN(location_id) || isNaN(memory) || isNaN(cpu) || isNaN(disk)) {
        alert("Lengkapi semua field konfigurasi Pterodactyl yang wajib (Nama, Egg ID, Nest ID, Location ID, Memory, CPU, Disk)!");
        return;
      }

      const configData = {
        name, egg_id, nest_id, location_id, memory, cpu, disk, swap, io
      };

      let error;
      if (configId) {
        // Update konfigurasi yang sudah ada.
        ({ error } = await window.supabase.from("pterodactyl_configs").update(configData).eq("id", configId));
      } else {
        // Tambahkan konfigurasi baru.
        ({ error } = await window.supabase.from("pterodactyl_configs").insert([configData]));
      }

      if (error) {
        alert("Gagal menyimpan konfigurasi: " + error.message);
        console.error("Error saving Pterodactyl config:", error);
        return;
      }

      alert("Konfigurasi Pterodactyl berhasil disimpan!");
      document.getElementById("pterodactylConfigForm").reset(); // Reset form.
      document.getElementById("configId").value = ""; // Bersihkan hidden ID.
      await loadPterodactylConfigs(); // Muat ulang konfigurasi.
      renderPterodactylConfigs(); // Render ulang daftar.
      populatePterodactylConfigDropdown(); // Perbarui dropdown produk.
    }

    /**
     * Mengisi form edit dengan data konfigurasi Pterodactyl yang dipilih.
     * @param {string} id - ID konfigurasi yang akan diedit.
     */
    async function editPterodactylConfig(id) {
      const config = pterodactylConfigs.find(c => c.id === id);
      if (!config) return alert("Konfigurasi tidak ditemukan.");

      // Isi form dengan data konfigurasi.
      document.getElementById("configId").value = config.id;
      document.getElementById("configName").value = config.name;
      document.getElementById("configEggId").value = config.egg_id;
      document.getElementById("configNestId").value = config.nest_id;
      document.getElementById("configLocationId").value = config.location_id;
      document.getElementById("configMemory").value = config.memory;
      document.getElementById("configCpu").value = config.cpu;
      document.getElementById("configDisk").value = config.disk;
      document.getElementById("configSwap").value = config.swap;
      document.getElementById("configIo").value = config.io;

      // Scroll ke form agar terlihat.
      document.getElementById("pterodactylConfigForm").scrollIntoView({ behavior: 'smooth' });
    }

    /**
     * Menghapus konfigurasi Pterodactyl dari database.
     * @param {string} id - ID konfigurasi yang akan dihapus.
     */
    async function deletePterodactylConfig(id) {
      if (!confirm("Yakin ingin menghapus konfigurasi ini? Produk yang menggunakan konfigurasi ini mungkin akan terpengaruh.")) return;

      const { error } = await window.supabase.from("pterodactyl_configs").delete().eq("id", id);
      if (error) {
        alert("Gagal menghapus konfigurasi: " + error.message);
        console.error("Error deleting Pterodactyl config:", error);
        return;
      }
      alert("Konfigurasi berhasil dihapus.");
      await loadPterodactylConfigs(); // Muat ulang konfigurasi.
      renderPterodactylConfigs(); // Render ulang daftar.
      loadProducts(); // Muat ulang produk untuk merefleksikan perubahan.
    }

    /**
     * Memuat pengaturan global Pterodactyl (URL panel dan API key) dan daftar konfigurasi.
     */
    async function loadPterodactylSettings() {
      await loadPterodactylConfigs(); // Muat konfigurasi untuk dropdown produk dan daftar.
      renderPterodactylConfigs(); // Render daftar konfigurasi.

      const { data, error } = await window.supabase.from("settings").select("pterodactyl_panel_url, pterodactyl_api_key").single();
      if (error && error.code !== 'PGRST116') { // PGRST116 berarti tidak ada baris ditemukan.
        console.error("Error loading Pterodactyl global settings:", error);
        document.getElementById("pterodactylPanelUrl").value = "";
        document.getElementById("pterodactylApiKey").value = "";
        return;
      }

      // Isi form pengaturan global.
      if (data) {
        document.getElementById("pterodactylPanelUrl").value = data.pterodactyl_panel_url || "";
        document.getElementById("pterodactylApiKey").value = data.pterodactyl_api_key || "";
      } else {
        document.getElementById("pterodactylPanelUrl").value = "";
        document.getElementById("pterodactylApiKey").value = "";
      }
    }

    /**
     * Menyimpan pengaturan global Pterodactyl ke database.
     * @param {Event} event - Objek event dari form submit.
     */
    async function savePterodactylGlobalSettings(event) {
      event.preventDefault();
      const panelUrl = document.getElementById("pterodactylPanelUrl").value;
      const apiKey = document.getElementById("pterodactylApiKey").value;

      if (!panelUrl || !apiKey) {
        alert("URL Panel dan API Key Pterodactyl wajib diisi!");
        return;
      }

      // Cek apakah sudah ada pengaturan global.
      const { data: existingSettings, error: fetchError } = await window.supabase
        .from("settings")
        .select("id")
        .limit(1)
        .single();

      let error;
      if (existingSettings) {
        // Update pengaturan yang sudah ada.
        ({ error } = await window.supabase
          .from("settings")
          .update({ pterodactyl_panel_url: panelUrl, pterodactyl_api_key: apiKey, updated_at: new Date() })
          .eq("id", existingSettings.id));
      } else {
        // Insert pengaturan baru.
        ({ error } = await window.supabase
          .from("settings")
          .insert([{ pterodactyl_panel_url: panelUrl, pterodactyl_api_key: apiKey }]));
      }

      if (error) {
        alert("Gagal menyimpan pengaturan Pterodactyl: " + error.message);
        console.error("Error saving Pterodactyl global settings:", error);
        return;
      }

      alert("Pengaturan Pterodactyl berhasil disimpan!");
      loadPterodactylSettings(); // Muat ulang pengaturan.
    }

    // --- END Pterodactyl Config Management ---

    /**
     * Memuat daftar produk dari database.
     */
    async function loadProducts() {
      await loadPterodactylConfigs(); // PENTING: Pastikan konfigurasi dimuat sebelum produk.
      populatePterodactylConfigDropdown(); // PENTING: Isi dropdown setelah konfigurasi dimuat.

      const { data, error } = await window.supabase
        .from("products")
        .select(`
          *,
          pterodactyl_configs (
            name as config_name,
            egg_id,
            nest_id,
            location_id,
            memory,
            cpu,
            disk
          )
        `)
        .order("name", { ascending: true });
      if (error) {
        console.error("Error loading products:", error);
        return;
      }

      const container = document.getElementById("productsList");
      container.innerHTML = "";

      if (data && data.length > 0) {
        data.forEach((p) => {
          const safeName = p.name.replace(/'/g, "\\'");
          let stockInfo = '';
          let stockButtons = '';
          let pterodactylConfigInfo = '';

          if (p.category === 'game_account') {
            stockInfo = ` | Stok: <strong>${p.stock}</strong>`;
            stockButtons = `
              <button onclick="updateProductStock('${p.id}', ${p.stock - 1})" class="admin-button">-</button>
              <button onclick="updateProductStock('${p.id}', ${p.stock + 1})" class="admin-button">+</button>
            `;
          } else if (p.category === 'panel_pterodactyl' && p.pterodactyl_configs) {
            // Tampilkan detail konfigurasi Pterodactyl jika ada.
            pterodactylConfigInfo = `
              <br>Paket: <strong>${p.pterodactyl_configs.config_name || 'N/A'}</strong>
              <br>Egg ID: ${p.pterodactyl_configs.egg_id || '-'}, Nest ID: ${p.pterodactyl_configs.nest_id || '-'}, Location ID: ${p.pterodactyl_configs.location_id || '-'}
              <br>Memory: ${p.pterodactyl_configs.memory || '-'}MB, CPU: ${p.pterodactyl_configs.cpu || '-'}%, Disk: ${p.pterodactyl_configs.disk || '-'}MB
            `;
          }

          const div = document.createElement("div");
          div.innerHTML = `
            <p><strong>${p.name}</strong> - Rp ${p.price.toLocaleString()} (${p.category === 'panel_pterodactyl' ? 'Panel Pterodactyl' : 'Akun Game'})${stockInfo}${pterodactylConfigInfo}</p>
            <div class="product-actions">
              ${stockButtons}
              <button onclick="deleteProduct('${p.id}')" class="admin-button delete">üóëÔ∏è Hapus</button>
              <button onclick="toggleProduct('${p.id}', ${p.active ? "false" : "true"})" class="admin-button">
                ${p.active ? "Nonaktifkan" : "Aktifkan"}
              </button>
            </div>
          `;
          container.appendChild(div);
        });
      } else {
        container.innerHTML = "<p>Tidak ada produk.</p>";
      }
    }

    /**
     * Mengisi dropdown pilihan konfigurasi Pterodactyl di form tambah produk.
     */
    function populatePterodactylConfigDropdown() {
      const select = document.getElementById("pterodactylConfigId");
      select.innerHTML = '<option value="">Pilih Konfigurasi Pterodactyl</option>'; // Opsi default.
      if (pterodactylConfigs && pterodactylConfigs.length > 0) {
        pterodactylConfigs.forEach(config => {
          const option = document.createElement("option");
          option.value = config.id;
          option.textContent = config.name;
          select.appendChild(option);
        });
      }
      console.log("Dropdown populated with Pterodactyl configs.");
    }

    /**
     * Menambahkan produk baru ke database.
     * @param {Event} event - Objek event dari form submit.
     */
    async function addProduct(event) {
      event.preventDefault();
      const name = document.getElementById("productName").value;
      const price = parseInt(document.getElementById("productPrice").value, 10);
      const category = document.getElementById("productCategory").value;
      const stock = parseInt(document.getElementById("productStock").value, 10);
      const pterodactylConfigId = document.getElementById("pterodactylConfigId").value;
      const file = document.getElementById("productImage").files[0];

      if (!name || !price || !category || !file) {
        alert("Lengkapi semua field yang wajib diisi!");
        return;
      }

      if (category === 'game_account' && (isNaN(stock) || stock < 0)) {
        alert("Stok harus angka non-negatif untuk Akun Game.");
        return;
      }

      if (category === 'panel_pterodactyl' && !pterodactylConfigId) {
        alert("Pilih konfigurasi Pterodactyl untuk produk panel!");
        return;
      }

      if (file.size > 2 * 1024 * 1024) {
        alert("Ukuran gambar terlalu besar. Maksimal 2MB.");
        return;
      }

      // Upload gambar produk ke Supabase Storage.
      const fileName = `${Date.now()}_${file.name.replace(/\s+/g, "_")}`;
      const { error: upErr } = await window.supabase.storage.from("product-images").upload(fileName, file);
      if (upErr) {
        alert("Upload gambar gagal: " + upErr.message);
        return;
      }

      const { data: urlData } = window.supabase.storage.from("product-images").getPublicUrl(fileName);

      const productData = {
        name,
        price,
        image: urlData.publicUrl,
        active: true,
        category,
        stock: category === 'game_account' ? stock : null, // Stok hanya untuk kategori 'game_account'.
        pterodactyl_config_id: category === 'panel_pterodactyl' ? pterodactylConfigId : null, // Konfigurasi Pterodactyl hanya untuk kategori 'panel_pterodactyl'.
      };

      const { error } = await window.supabase.from("products").insert([productData]);
      if (error) {
        alert("Gagal tambah produk: " + error.message);
        return;
      }

      alert("Produk berhasil ditambahkan!");
      document.getElementById("addProductForm").reset();
      document.getElementById("productImage").value = ""; // Bersihkan input file.
      togglePterodactylFields(); // Reset tampilan field Pterodactyl/stok.
      loadProducts(); // Muat ulang daftar produk.
    }

    /**
     * Menghapus produk dari database.
     * @param {string} id - ID produk yang akan dihapus.
     */
    async function deleteProduct(id) {
      if (!confirm("Yakin ingin menghapus produk ini?")) return;
      const { error } = await window.supabase.from("products").delete().eq("id", id);
      if (error) {
        alert("Gagal menghapus produk: " + error.message);
        return;
      }
      alert("Produk berhasil dihapus.");
      loadProducts();
    }

    /**
     * Mengubah status aktif/nonaktif produk.
     * @param {string} id - ID produk.
     * @param {boolean} newStatus - Status baru (true untuk aktif, false untuk nonaktif).
     */
    async function toggleProduct(id, newStatus) {
      const { error } = await window.supabase
        .from("products")
        .update({ active: newStatus })
        .eq("id", id);

      if (error) {
        alert("Gagal mengubah status produk: " + error.message);
        return;
      }

      alert(`Produk berhasil di${newStatus ? "aktifkan" : "nonaktifkan"}.`);
      loadProducts();
    }

    /**
     * Memperbarui stok produk (hanya untuk kategori 'game_account').
     * @param {string} id - ID produk.
     * @param {number} newStock - Jumlah stok baru.
     */
    async function updateProductStock(id, newStock) {
      if (newStock < 0) {
        alert("Stok tidak bisa kurang dari 0.");
        return;
      }
      const { error } = await window.supabase
        .from("products")
        .update({ stock: newStock })
        .eq("id", id);

      if (error) {
        alert("Gagal mengubah stok produk: " + error.message);
        return;
      }

      alert("Stok produk berhasil diupdate.");
      loadProducts();
    }

    /**
     * Memuat daftar pesanan dari database.
     */
    async function loadOrders() {
      const { data, error } = await window.supabase
        .from("orders_view") // Menggunakan view untuk mendapatkan detail produk dan user.
        .select("*")
        .order("created_at", { ascending: false });

      if (error) {
        console.error("Error loading orders:", error);
        return;
      }

      const container = document.getElementById("ordersList");
      container.innerHTML = "";

      if (data && data.length > 0) {
        for (const o of data) {
          const div = document.createElement("div");
          div.className = "order";

          let provisionButton = '';
          // Tampilkan tombol provision jika produk Pterodactyl, status 'payment_received', dan belum diprovision.
          if (o.product_category === 'panel_pterodactyl' && o.status === 'payment_received' && !o.pterodactyl_server_id) {
            provisionButton = `<button onclick="provisionPterodactylServer('${o.id}')" class="admin-button" style="background: #007bff;">Provision Server</button>`;
          } else if (o.product_category === 'panel_pterodactyl' && o.pterodactyl_server_id) {
            // Tampilkan status jika sudah diprovision.
            provisionButton = `<span style="color: #28a745; margin-left: 10px;">Server Provisioned (ID: ${o.pterodactyl_server_id.substring(0, 8)}...)</span>`;
          }

          div.innerHTML = `
            <p>Order ID: ${o.id}</p>
            <p>User: ${o.username}</p>
            <p>Produk: ${o.product_name} - Rp ${o.product_price.toLocaleString()} (${o.product_category === 'panel_pterodactyl' ? 'Panel Pterodactyl' : 'Akun Game'})</p>
            <p>Status Saat Ini: ${o.status.replace(/_/g, ' ').toUpperCase()}</p>
            <p>Bukti TF: ${
              o.payment_proof ? `<a href="${o.payment_proof}" target="_blank">Lihat</a>` : "-"
            }</p>
            <p>Email Kontak: ${o.contact_email || "-"}</p>
            <div class="order-actions">
              <select id="status-${o.id}">
                <option value="">--Pilih Status Baru--</option>
                <option value="waiting_confirmation" ${o.status === 'waiting_confirmation' ? 'selected' : ''}>Menunggu Konfirmasi</option>
                <option value="payment_received" ${o.status === 'payment_received' ? 'selected' : ''}>Pembayaran Diterima</option>
                <option value="payment_failed" ${o.status === 'payment_failed' ? 'selected' : ''}>Pembayaran Gagal</option>
                <option value="done" ${o.status === 'done' ? 'selected' : ''}>Pesanan Selesai</option>
              </select>
              <button onclick="saveOrderStatus('${o.id}')" class="admin-button">Update Status</button>
              ${provisionButton}
            </div>
          `;
          container.appendChild(div);
        }
      } else {
        container.innerHTML = "<p>Belum ada pesanan.</p>";
      }
    }

    /**
     * Menyimpan status pesanan yang diperbarui dan mengirim notifikasi.
     * @param {string} orderId - ID pesanan yang akan diperbarui.
     */
    async function saveOrderStatus(orderId) {
      const newStatus = document.getElementById(`status-${orderId}`).value;
      if (!newStatus) return alert("Pilih status baru dulu.");

      const { error, data: orderData } = await window.supabase
        .from("orders")
        .update({ status: newStatus })
        .eq("id", orderId)
        .select(`
          id,
          user_id,
          product_id,
          status,
          payment_proof,
          contact_email,
          pterodactyl_server_id,
          products(category, name, pterodactyl_config_id)
        `)
        .single();

      if (error) {
        alert("Gagal update status pesanan: " + error.message);
        return;
      }

      const { data: userData } = await window.supabase
        .from("users")
        .select("username")
        .eq("id", orderData.user_id)
        .single();

      // Jika pembayaran diterima untuk produk Pterodactyl dan belum diprovision, tawarkan untuk provision.
      if ((newStatus === 'payment_received' || newStatus === 'done') && orderData.products.category === 'panel_pterodactyl' && !orderData.pterodactyl_server_id) {
        const confirmProvision = confirm("Pembayaran diterima untuk produk Pterodactyl. Apakah Anda ingin langsung memprovision server?");
        if (confirmProvision) {
          // Panggil fungsi provisionPterodactylServer.
          // Perhatikan: `event` tidak tersedia di sini, jadi kita perlu memanggilnya tanpa `event.target`.
          // Fungsi provisionPterodactylServer perlu diadaptasi agar bisa dipanggil tanpa event.
          // Untuk sementara, kita bisa memanggilnya langsung dan mengelola UI secara terpisah jika diperlukan.
          await provisionPterodactylServer(orderId);
        }
      }

      // Ambil URL Pterodactyl Panel untuk notifikasi.
      const { data: settingsData } = await window.supabase.from("settings").select("pterodactyl_panel_url").single();
      const pterodactylPanelUrl = settingsData?.pterodactyl_panel_url || "-";

      // Kirim notifikasi ke Telegram admin.
      await fetch("/api/notify", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          orders: [{
            id: orderData.id,
            username: userData?.username || "Unknown User",
            product_name: orderData.products.name || "Unknown Product",
            payment_method: "qris", // Asumsi metode pembayaran QRIS
            payment_proof: orderData.payment_proof,
            status: orderData.status,
            contact_email: orderData.contact_email,
            product_category: orderData.products.category,
            pterodactyl_server_id: orderData.pterodactyl_server_id,
            pterodactyl_panel_url: pterodactylPanelUrl, // Kirim ke notify API
          }],
        }),
      });

      alert("‚úÖ Status pesanan berhasil diupdate.");
      loadOrders(); // Muat ulang daftar pesanan.
    }

    /**
     * Memprovision server Pterodactyl untuk pesanan tertentu.
     * @param {string} orderId - ID pesanan yang akan diprovision.
     */
    async function provisionPterodactylServer(orderId) {
      if (!confirm("Yakin ingin memprovision server Pterodactyl untuk pesanan ini? Ini akan membuat server dan mengirim detail ke pengguna.")) {
        return;
      }

      // Cari tombol yang memicu aksi ini untuk menonaktifkannya sementara.
      // Ini adalah pendekatan yang sedikit hacky karena tidak ada event.target langsung.
      // Idealnya, tombol ini harus memiliki ID unik atau diakses melalui DOM traversal yang lebih spesifik.
      const button = document.querySelector(`#ordersList button[onclick="provisionPterodactylServer('${orderId}')"]`);
      if (button) {
        button.disabled = true;
        button.textContent = "Processing...";
      }

      try {
        const response = await fetch("/api/provision-pterodactyl", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ order_id: orderId }),
        });

        const result = await response.json();

        if (result.success) {
          alert("‚úÖ Server Pterodactyl berhasil diprovision dan detail dikirim ke pengguna!");
          loadOrders(); // Muat ulang pesanan untuk melihat status terbaru.
        } else {
          alert("‚ùå Gagal memprovision server Pterodactyl: " + (result.error || "Unknown error"));
          console.error("Provisioning error:", result);
        }
      } catch (error) {
        alert("‚ùå Terjadi kesalahan saat memanggil API provisioning: " + error.message);
        console.error("Fetch error:", error);
      } finally {
        if (button) {
          button.disabled = false;
          button.textContent = "Provision Server";
        }
      }
    }

    /**
     * Memuat pengaturan QRIS dan pengumuman.
     */
    async function loadQrisSettings() {
      const { data, error } = await window.supabase.from("settings").select("qris_image_url, announcement").single();
      const currentQrisImage = document.getElementById("currentQrisImage");
      const noQrisMessage = document.getElementById("noQrisMessage");
      const announcementTextarea = document.getElementById("announcementText");

      if (error && error.code !== 'PGRST116') {
        console.error("Error loading settings:", error);
        currentQrisImage.style.display = 'none';
        noQrisMessage.style.display = 'block';
        announcementTextarea.value = "";
        return;
      }

      if (data) {
        if (data.qris_image_url) {
          currentQrisImage.src = data.qris_image_url;
          currentQrisImage.style.display = 'block';
          noQrisMessage.style.display = 'none';
        } else {
          currentQrisImage.style.display = 'none';
          noQrisMessage.style.display = 'block';
        }
        announcementTextarea.value = data.announcement || "";
      } else {
        currentQrisImage.style.display = 'none';
        noQrisMessage.style.display = 'block';
        announcementTextarea.value = "";
      }
    }

    /**
     * Mengupload gambar QRIS baru dan menyimpannya di pengaturan.
     * @param {Event} event - Objek event dari form submit.
     */
    async function uploadQrisImage(event) {
      event.preventDefault();
      const file = document.getElementById("qrisImageFile").files[0];

      if (!file) {
        alert("Pilih file gambar QRIS untuk diupload!");
        return;
      }

      if (file.size > 2 * 1024 * 1024) {
        alert("Ukuran gambar QRIS terlalu besar. Maksimal 2MB.");
        return;
      }

      const fileName = `qris_${Date.now()}_${file.name.replace(/\s+/g, "_")}`;
      const { error: uploadError } = await window.supabase.storage.from("qris-images").upload(fileName, file, {
        cacheControl: '3600',
        upsert: false
      });

      if (uploadError) {
        alert("Gagal upload gambar QRIS: " + uploadError.message);
        return;
      }

      const { data: urlData } = window.supabase.storage.from("qris-images").getPublicUrl(fileName);
      const qrisImageUrl = urlData.publicUrl;

      const { data: existingSettings, error: fetchError } = await window.supabase
        .from("settings")
        .select("id")
        .limit(1)
        .single();

      let error;
      if (existingSettings) {
        ({ error } = await window.supabase
          .from("settings")
          .update({ qris_image_url: qrisImageUrl, updated_at: new Date() })
          .eq("id", existingSettings.id));
      } else {
        ({ error } = await window.supabase
          .from("settings")
          .insert([{ qris_image_url: qrisImageUrl }]));
      }

      if (error) {
        alert("Gagal menyimpan URL QRIS: " + error.message);
        return;
      }

      alert("Gambar QRIS berhasil diupload dan disimpan!");
      document.getElementById("uploadQrisForm").reset();
      loadQrisSettings();
    }

    /**
     * Menyimpan teks pengumuman ke pengaturan.
     * @param {Event} event - Objek event dari form submit.
     */
    async function saveAnnouncement(event) {
      event.preventDefault();
      const announcementText = document.getElementById("announcementText").value;

      const { data: existingSettings, error: fetchError } = await window.supabase
        .from("settings")
        .select("id")
        .limit(1)
        .single();

      let error;
      if (existingSettings) {
        ({ error } = await window.supabase
          .from("settings")
          .update({ announcement: announcementText, updated_at: new Date() })
          .eq("id", existingSettings.id));
      } else {
        ({ error } = await window.supabase
          .from("settings")
          .insert([{ announcement: announcementText }]));
      }

      if (error) {
        alert("Gagal menyimpan pengumuman: " + error.message);
        return;
      }

      alert("Pengumuman berhasil disimpan!");
      loadQrisSettings();
    }

    /**
     * Memuat daftar rating dan komentar pengguna.
     */
    async function loadRatings() {
      const { data: ratings, error } = await window.supabase
        .from("ratings")
        .select(`
          id,
          rating,
          comment,
          created_at,
          users(username),
          products(name)
        `)
        .order("created_at", { ascending: false });

      if (error) {
        console.error("Error loading ratings:", error);
        return;
      }

      const container = document.getElementById("ratingsList");
      container.innerHTML = "";

      if (ratings && ratings.length > 0) {
        displayRatingStatistics(ratings); // Tampilkan statistik rating.

        const table = document.createElement("table");
        table.className = "ratings-table";
        table.innerHTML = `
          <thead>
            <tr>
              <th>User</th>
              <th>Produk</th>
              <th>Rating</th>
              <th>Komentar</th>
              <th>Tanggal</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        `;
        const tbody = table.querySelector("tbody");

        ratings.forEach((r) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${r.users ? r.users.username : 'N/A'}</td>
            <td>${r.products ? r.products.name : 'N/A'}</td>
            <td>${'‚≠ê'.repeat(r.rating)} (${r.rating}/5)</td>
            <td>${r.comment || '-'}</td>
            <td>${new Date(r.created_at).toLocaleString()}</td>
            <td>
              <button onclick="deleteRating('${r.id}')" class="admin-button delete">üóëÔ∏è Hapus</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
        container.appendChild(table);
      } else {
        // Reset statistik jika tidak ada rating.
        document.getElementById("totalRatingsCount").textContent = "0";
        document.getElementById("averageRating").textContent = "0.0";
        for (let i = 1; i <= 5; i++) {
          document.getElementById(`star${i}Count`).textContent = "0";
          document.getElementById(`star${i}Percent`).textContent = "0%";
          document.getElementById(`star${i}Bar`).style.width = "0%";
        }
        container.innerHTML = "<p>Belum ada rating atau komentar.</p>";
      }
    }

    /**
     * Menghapus rating dari database.
     * @param {string} ratingId - ID rating yang akan dihapus.
     */
    async function deleteRating(ratingId) {
      if (!confirm("Yakin ingin menghapus rating ini?")) return;

      const { error } = await window.supabase.from("ratings").delete().eq("id", ratingId);

      if (error) {
        alert("Gagal menghapus rating: " + error.message);
        console.error("Error deleting rating:", error);
        return;
      }

      alert("Rating berhasil dihapus.");
      loadRatings(); // Muat ulang daftar rating.
    }

    /**
     * Menampilkan statistik rating (total, rata-rata, persentase per bintang).
     * @param {Array} ratings - Array objek rating.
     */
    function displayRatingStatistics(ratings) {
      const totalRatings = ratings.length;
      let sumRatings = 0;
      const starCounts = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };

      ratings.forEach(r => {
        sumRatings += r.rating;
        starCounts[r.rating]++;
      });

      const averageRating = totalRatings > 0 ? (sumRatings / totalRatings).toFixed(1) : "0.0";

      document.getElementById("totalRatingsCount").textContent = totalRatings;
      document.getElementById("averageRating").textContent = averageRating;

      for (let i = 1; i <= 5; i++) {
        const count = starCounts[i];
        const percentage = totalRatings > 0 ? ((count / totalRatings) * 100).toFixed(1) : "0.0";
        document.getElementById(`star${i}Count`).textContent = count;
        document.getElementById(`star${i}Percent`).textContent = `${percentage}%`;
        document.getElementById(`star${i}Bar`).style.width = `${percentage}%`;
      }
    }

    /**
     * Melakukan logout pengguna admin.
     */
    async function logout() {
      await window.supabase.auth.signOut();
      window.location.href = "signin.html";
    }

    // PENTING: Panggil fungsi checkAdminAuth saat halaman dimuat.
    window.onload = checkAdminAuth;

    /**
     * Mengatur visibilitas field konfigurasi Pterodactyl atau stok
     * berdasarkan kategori produk yang dipilih.
     */
    function togglePterodactylFields() {
      const category = document.getElementById("productCategory").value;
      const pterodactylConfigDropdown = document.getElementById("pterodactylConfigDropdown");
      const productStockInput = document.getElementById("productStock"); // Mengganti nama variabel agar lebih jelas

      if (category === "panel_pterodactyl") {
        pterodactylConfigDropdown.style.display = "block"; // Tampilkan dropdown Pterodactyl
        productStockInput.style.display = "none"; // Sembunyikan input stok
        productStockInput.value = "0"; // Set nilai stok ke 0 (atau kosongkan)
        productStockInput.removeAttribute("required"); // Hapus atribut required
      } else if (category === "game_account") {
        pterodactylConfigDropdown.style.display = "none"; // Sembunyikan dropdown Pterodactyl
        productStockInput.style.display = "block"; // Tampilkan input stok
        productStockInput.setAttribute("required", "required"); // Tambahkan atribut required
      } else {
        // Untuk kategori lain atau jika belum memilih
        pterodactylConfigDropdown.style.display = "none";
        productStockInput.style.display = "block";
        productStockInput.setAttribute("required", "required");
      }
      console.log("togglePterodactylFields triggered. Category:", category); // Debugging log
    }

    // PENTING: Panggil togglePterodactylFields saat DOM selesai dimuat
    // untuk mengatur tampilan awal form tambah produk.
    document.addEventListener('DOMContentLoaded', () => {
      togglePterodactylFields(); // Panggil sekali saat halaman dimuat
      // Tambahkan event listener untuk perubahan kategori produk
      document.getElementById("productCategory").addEventListener("change", togglePterodactylFields);
    });
  </script>
  <style>
    /* Tambahan styling agar dropdown + tombol rapi */
    .order select {
      margin-right: 0.5rem;
      min-width: 200px;
    }

    .order-actions {
      margin-top: 0.8rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap; /* Tambahkan ini agar tombol tidak tumpang tindih di layar kecil */
    }

    .order-actions button {
      background: #238636;
      color: white;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .order-actions button:hover {
      background: #2ea043;
    }

    /* NEW: Styling for Pterodactyl config fields */
    .pterodactyl-config-fields {
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1rem;
      background: #0d1117;
    }
    .pterodactyl-config-fields h3 {
      color: #58a6ff;
      margin-bottom: 1rem;
      text-align: left;
    }
    .pterodactyl-config-fields label {
      display: block;
      margin-bottom: 0.5rem;
      color: #e6edf3;
    }
    .pterodactyl-config-fields input[type="number"],
    .pterodactyl-config-fields input[type="text"],
    .pterodactyl-config-fields select { /* Tambahkan select di sini */
      width: calc(100% - 1rem);
      margin-bottom: 1rem;
    }

    /* NEW: Styling for Pterodactyl Config List Items */
    .pterodactyl-config-item {
      background: #0d1117;
      padding: 1rem;
      margin-bottom: 0.8rem;
      border-radius: 8px;
      border: 1px solid #30363d;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .pterodactyl-config-item p {
      margin: 0;
      color: #a0aec0;
    }
    .pterodactyl-config-item p strong {
      color: #e6edf3;
    }
    .config-actions {
      display: flex;
      gap: 0.6rem;
      margin-top: 0.5rem;
    }
  </style>
</head>
<body>
  <header>
    <nav>
      <button onclick="showSection('products')">Produk</button>
      <button onclick="showSection('orders')">Pesanan</button>
      <button onclick="showSection('ratings')">Rating & Komentar</button>
      <button onclick="showSection('settings')">Pengaturan Umum</button>
      <button onclick="showSection('pterodactyl-settings')">Pengaturan Pterodactyl</button> <!-- NEW NAV BUTTON -->
      <button onclick="logout()">Logout</button>
    </nav>
  </header>

  <main>
    <!-- Produk -->
    <section id="products">
      <h2>Tambah Produk</h2>
      <form id="addProductForm" onsubmit="addProduct(event)">
        <input type="text" id="productName" placeholder="Nama produk" required>
        <input type="number" id="productPrice" placeholder="Harga (Rp)" required>
        <select id="productCategory" required onchange="togglePterodactylFields()">
          <option value="">Pilih Kategori</option>
          <option value="panel_pterodactyl">Panel Pterodactyl</option>
          <option value="game_account">Jual Akun Game</option>
        </select>
        <input type="number" id="productStock" placeholder="Stok (hanya untuk Akun Game)" min="0" value="0">
        <input type="file" id="productImage" accept="image/*" required>

        <!-- NEW: Pterodactyl Configuration Dropdown -->
        <div id="pterodactylConfigDropdown" class="pterodactyl-config-fields" style="display:none;">
          <h3>Pilih Paket Pterodactyl</h3>
          <label for="pterodactylConfigId">Pilih Konfigurasi:</label>
          <select id="pterodactylConfigId"> <!-- Hapus 'required' di sini, karena akan diatur oleh JS -->
            <option value="">Pilih Konfigurasi Pterodactyl</option>
            <!-- Options will be populated by JS -->
          </select>
        </div>

        <button type="submit" class="admin-button">Tambah Produk</button>
      </form>

      <h2>Daftar Produk</h2>
      <div id="productsList"></div>
    </section>

    <!-- Pesanan -->
    <section id="orders" style="display:none;">
      <h2>Daftar Pesanan</h2>
      <div id="ordersList"></div>
    </section>

    <!-- Rating & Komentar -->
    <section id="ratings" style="display:none;">
      <h2>Rating & Komentar Pengguna</h2>

      <div class="rating-summary">
        <h3>Statistik Rating</h3>
        <div id="ratingStats">
          <p>Total Rating: <strong id="totalRatingsCount">0</strong></p>
          <p>Rata-rata Rating: <strong id="averageRating">0.0</strong></p>
          <p>Bintang 5: <strong id="star5Count">0</strong> (<span id="star5Percent">0%</span>)
            <div class="progress-bar-container"><div id="star5Bar" class="progress-bar"></div></div></p>
          <p>Bintang 4: <strong id="star4Count">0</strong> (<span id="star4Percent">0%</span>)
            <div class="progress-bar-container"><div id="star4Bar" class="progress-bar"></div></div></p>
          <p>Bintang 3: <strong id="star3Count">0</strong> (<span id="star3Percent">0%</span>)
            <div class="progress-bar-container"><div id="star3Bar" class="progress-bar"></div></div></p>
          <p>Bintang 2: <strong id="star2Count">0</strong> (<span id="star2Percent">0%</span>)
            <div class="progress-bar-container"><div id="star2Bar" class="progress-bar"></div></div></p>
          <p>Bintang 1: <strong id="star1Count">0</strong> (<span id="star1Percent">0%</span>)
            <div class="progress-bar-container"><div id="star1Bar" class="progress-bar"></div></div></p>
        </div>
      </div>

      <div id="ratingsList">
        <!-- Daftar rating akan dimuat di sini oleh JS -->
      </div>
    </section>

    <!-- Pengaturan Umum -->
    <section id="settings" style="display:none;">
      <h2>Pengaturan QRIS</h2>
      <form id="uploadQrisForm" onsubmit="uploadQrisImage(event)">
        <label for="qrisImageFile">Upload Gambar QRIS Baru:</label>
        <input type="file" id="qrisImageFile" accept="image/*" required>
        <button type="submit" class="admin-button">Upload & Simpan QRIS</button>
      </form>

      <div style="margin-top: 20px;">
        <h3>QRIS Saat Ini:</h3>
        <img id="currentQrisImage" src="" alt="QRIS Saat Ini" style="max-width: 200px; height: auto; border: 1px solid #238636; border-radius: 8px; display: none;">
        <p id="noQrisMessage" style="color: #a0aec0;">Belum ada gambar QRIS diatur.</p>
      </div>

      <h2 style="margin-top: 3rem;">Pengaturan Pengumuman</h2>
      <form id="announcementForm" onsubmit="saveAnnouncement(event)">
        <label for="announcementText">Teks Pengumuman:</label>
        <textarea id="announcementText" rows="5" placeholder="Masukkan teks pengumuman di sini..."></textarea>
        <button type="submit" class="admin-button">Simpan Pengumuman</button>
      </form>
    </section>

    <!-- NEW SECTION: Pengaturan Pterodactyl -->
    <section id="pterodactyl-settings" style="display:none;">
      <h2>Pengaturan Global Pterodactyl</h2>
      <form id="pterodactylGlobalSettingsForm" onsubmit="savePterodactylGlobalSettings(event)">
        <label for="pterodactylPanelUrl">URL Panel Pterodactyl:</label>
        <input type="url" id="pterodactylPanelUrl" placeholder="Contoh: https://panel.example.com" required>
        <label for="pterodactylApiKey">Application API Key Pterodactyl:</label>
        <input type="text" id="pterodactylApiKey" placeholder="Contoh: ptla_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" required>
        <button type="submit" class="admin-button">Simpan Pengaturan Pterodactyl</button>
      </form>

      <h2 style="margin-top: 3rem;">Tambah/Edit Konfigurasi Paket Pterodactyl</h2>
      <form id="pterodactylConfigForm" onsubmit="addOrUpdatePterodactylConfig(event)">
        <input type="hidden" id="configId">
        <label for="configName">Nama Paket (Contoh: 1GB RAM, 9GB RAM, Unlimited):</label>
        <input type="text" id="configName" placeholder="Nama Paket" required>
        <label for="configEggId">Egg ID:</label>
        <input type="number" id="configEggId" placeholder="Contoh: 1 (Minecraft Java)" value="1" required>
        <label for="configNestId">Nest ID:</label>
        <input type="number" id="configNestId" placeholder="Contoh: 1 (Minecraft)" value="1" required>
        <label for="configLocationId">Location ID:</label>
        <input type="number" id="configLocationId" placeholder="Contoh: 1 (US-East)" value="1" required>
        <label for="configMemory">Memory (MB):</label>
        <input type="number" id="configMemory" placeholder="Contoh: 1024" value="1024" required>
        <label for="configCpu">CPU (%):</label>
        <input type="number" id="configCpu" placeholder="Contoh: 100" value="100" required>
        <label for="configDisk">Disk (MB):</label>
        <input type="number" id="configDisk" placeholder="Contoh: 10240" value="10240" required>
        <label for="configSwap">Swap (MB):</label>
        <input type="number" id="configSwap" placeholder="Contoh: 0" value="0">
        <label for="configIo">IO (Block I/O):</label>
        <input type="number" id="configIo" placeholder="Contoh: 500" value="500">
        <button type="submit" class="admin-button">Simpan Konfigurasi Paket</button>
      </form>

      <h2 style="margin-top: 3rem;">Daftar Konfigurasi Paket Pterodactyl</h2>
      <div id="pterodactylConfigsList">
        <!-- List of Pterodactyl configs will be loaded here by JS -->
      </div>
    </section>
  </main>

  <footer>
    <p>&copy; 2025 STORESKULL</p>
  </footer>
</body>
</html>
